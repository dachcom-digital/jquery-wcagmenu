/*


 jquery-wcagmenu widget
 Copyright 2015 DACHCOM.DIGITAL AG

 @author Volker Andres
 @see https://github.com/dachcom-digital/jquery-wcagmenu
 @license MIT
 @version 0.1.4
*/
(function(f){f.widget("dcd.wcagmenu",{options:{classOpen:"open",classFocus:"focus",controls:{},openDelay:300,closeDelay:300,childMenuSelector:"div:first",useMenuAim:!0},_keys:{tab:9,enter:13,esc:27,space:32,left:37,up:38,right:39,down:40},_currentFocus:f(),_closeTimeout:void 0,_openTimeout:void 0,_openDelay:300,_closeDelay:300,_mousePoints:{},_create:function(){this._on({keydown:"_keyevent",focus:"_focus",blur:"_blur",mouseover:"_mouseover",mousemove:"_mousemove",mouseleave:"_mouseleave",mouseenter:"_mouseenter"});
this._openDelay=this.options.openDelay;this._closeDelay=this.options.closeDelay;this._isTouchDevice()&&(this._openDelay=0);this.element.find("a").attr("tabindex",-1)},_isTouchDevice:function(){return void 0!==window.ontouchstart||window.navigator.MaxTouchPoints||window.navigator.msMaxTouchPoints||window.navigator.userAgent.toLowerCase().match(/windows phone os 7/i)},_mouseenter:function(){void 0!==this._closeTimeout&&window.clearTimeout(this._closeTimeout)},_mouseleave:function(){var a=this;void 0!==
a._closeTimeout&&window.clearTimeout(a._closeTimeout);a._closeTimeout=window.setTimeout(function(){a.element.find("."+a.options.classFocus).removeClass(a.options.classFocus);a._closeMenu()},a._closeDelay)},_mouseover:function(a){a=f(a.target).closest("[class*=level-]");a.length&&(this._currentFocus.length||this._isTouchDevice()||this.element.trigger("focus",{initial:!0}),this._getLevel(a)>this._getCurrentLevel()&&(window.clearTimeout(this._openTimeout),this._activateItem(a)))},_mousemove:function(a){f(a.target).closest("[class*=level-]").length&&
this._openItem(a)},_openItem:function(a){var b=this,c=b._currentFocus,d=c.find(this.options.childMenuSelector),h=f(a.target).closest("[class*=level-]"),e=this._openDelay;c.length?window.clearTimeout(this._openTimeout):e=0;0<e&&!b._currentFocus.find("[class*=level-]").length&&(e=0);0<e&&c.length&&d.length&&(this._resetDelayForMouse(a,h,d,c)&&(e=0),b._mousePoints.x=a.pageX,b._mousePoints.y=a.pageY);0===e?this._activateItem(h):this._openTimeout=window.setTimeout(function(){b._activateItem(h);b._mousePoints=
{}},e)},_activateItem:function(a){this.element.find("."+this.options.classFocus+", ."+this.options.classOpen).removeClass(this.options.classFocus+" "+this.options.classOpen);this._currentFocus=a.addClass(this.options.classFocus+" "+this.options.classOpen);this._currentFocus.find("."+this.options.classFocus+", ."+this.options.classOpen).removeClass(this.options.classFocus+" "+this.options.classOpen);this._currentFocus.closest("[class*=level-]")&&this._currentFocus.parents("[class*=level-]").addClass(this.options.classFocus+
" "+this.options.classOpen);this._trigger("open",{},[this._currentFocus])},_addFocus:function(a){a.addClass(this.options.classFocus);this._trigger("focus",{},[a]);return a},_removeFocus:function(a){return a.removeClass(this.options.classFocus)},_resetDelayForMouse:function(a,b,c,d){if(!this.options.useMenuAim)return!1;var h=this._getCurrentLevel(),e,l,n,m,g,k,p;if(void 0===this.options.controls[h])return!1;"open"===this.options.controls[h].down&&(e="down");"open"===this.options.controls[h].right&&
(e="right");"open"===this.options.controls[h].left&&(e="left");"open"===this.options.controls[h].up&&(e="up");"open"===b.data("down")&&(e="down");"open"===b.data("right")&&(e="right");"open"===b.data("left")&&(e="left");"open"===b.data("up")&&(e="up");switch(e){case "down":l=d.offset().left+d.width()/2;n=d.offset().top+d.height();m=c.offset().left;g=c.offset().top;k=c.offset().left+c.width();p=c.offset().top;break;case "right":l=d.offset().left+d.width();n=d.offset().top+d.height()/2;m=c.offset().left;
g=c.offset().top;k=c.offset().left;p=c.offset().top+c.height();break;case "left":l=d.offset().left;n=d.offset().top+d.height()/2;m=c.offset().left+c.width();g=c.offset().top;k=c.offset().left+c.width();p=c.offset().top+c.height();break;case "up":l=d.offset().left+d.width()/2,n=d.offset().top,m=c.offset().left,g=c.offset().top+c.height(),k=c.offset().left+c.width(),p=c.offset().top+c.height()}b=this._checkLineIntersection(this._mousePoints.x,this._mousePoints.y,a.pageX,a.pageY,l,n,m,g);l=this._checkLineIntersection(this._mousePoints.x,
this._mousePoints.y,a.pageX,a.pageY,l,n,k,p);a=this._checkLineIntersection(this._mousePoints.x,this._mousePoints.y,a.pageX,a.pageY,m,g,k,p);return!1===b.onLine2&&!1===l.onLine2&&!1===a.onLine2?!0:!1},_checkLineIntersection:function(a,b,c,d,h,e,l,n){var m,g,k,p,f={x:null,y:null,onLine1:!1,onLine2:!1};m=(n-e)*(c-a)-(l-h)*(d-b);if(0===m)return f;g=b-e;k=a-h;p=(c-a)*g-(d-b)*k;g=((l-h)*g-(n-e)*k)/m;k=p/m;f.x=a+g*(c-a);f.y=b+g*(d-b);0<g&&1>g&&(f.onLine1=!0);0<k&&1>k&&(f.onLine2=!0);return f},_focus:function(a,
b){b=b||{};var c=f(a.target);!b.initial&&c.is(this.element)&&this._focusMenu()},_blur:function(a){f(a.target).is(this.element)&&(this._removeFocus(this.element.find("."+this.options.classFocus)),this._currentFocus=f(),this._openTimeout=void 0)},_keyevent:function(a){switch(a.keyCode){case this._keys.tab:return this._closeMenu();case this._keys.esc:return this._focusMenu(),this._closeMenu();case this._keys.down:return this._key("down");case this._keys.up:return this._key("up");case this._keys.left:return this._key("left");
case this._keys.right:return this._key("right");case this._keys.space:return this._open("space");case this._keys.enter:return this._action()}},_getLevel:function(a){a=(a.attr("class")||"").match(/level-(\d+)/i);return null===a?0:window.parseInt(a[1],10)},_getCurrentLevel:function(){return this._getLevel(this._currentFocus)},_getSiblings:function(){var a=this._getCurrentLevel();return 1===a?this.element.find(".level-"+a):this._currentFocus.closest(".level-"+(a-1)).find(".level-"+a)},_open:function(a){var b;
b=this._getCurrentLevel();var c=this._currentFocus;b=this._currentFocus.find(".level-"+(b+1)+":first");return b.length?(this._currentFocus.addClass(this.options.classOpen),this._currentFocus=this._addFocus(b),this._trigger("open",{},[c]),!1):"space"===a?this._action():!1},_close:function(){var a;a=this._getCurrentLevel();a=this._currentFocus.closest(".level-"+(a-1));a.length&&(this._currentFocus=a.removeClass(this.options.classOpen),a.find("."+this.options.classFocus+", ."+this.options.classOpen).removeClass(this.options.classFocus+
" "+this.options.classOpen));return!1},_action:function(){window.location.href=this._currentFocus.find("a").attr("href");return!1},_key:function(a){var b=this._getCurrentLevel();a=this._currentFocus.data(a)||this.options.controls[b][a];return this["_"+(a||"none")]()},_none:function(){return!1},_left:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);0!==b&&(this._removeFocus(this._currentFocus),this._currentFocus=this._addFocus(a.eq(b-1)));return!1},_leftLoop:function(){var a,
b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);this._currentFocus=0===b?this._addFocus(a.eq(a.length-1)):this._addFocus(a.eq(b-1));return!1},_leftClose:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);0===b?this._close():this._currentFocus=this._addFocus(a.eq(b-1));return!1},_right:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);b!==a.length-1&&(this._removeFocus(this._currentFocus),
this._currentFocus=this._addFocus(a.eq(b+1)));return!1},_rightLoop:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);this._currentFocus=b===a.length-1?this._addFocus(a.eq(0)):this._addFocus(a.eq(b+1));return!1},_rightClose:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);b===a.length-1?this._close():this._currentFocus=this._addFocus(a.eq(b+1));return!1},_up:function(){return this._left()},
_upLoop:function(){return this._leftLoop()},_upClose:function(){return this._leftClose()},_down:function(){return this._right()},_downLoop:function(){return this._rightLoop()},_downClose:function(){return this._rightClose()},_focusMenu:function(){this._removeFocus(this.element.find("."+this.options.classFocus));this._currentFocus=this._addFocus(this.element.find(".level-1:first"))},_closeMenu:function(){this.element.find("."+this.options.classOpen).removeClass(this.options.classOpen)},_destroy:function(){this._removeFocus(this.element.find("."+
this.options.classFocus));this._closeMenu();this.element.find("[tabindex]").removeAttr("tabindex")}})})(jQuery);
