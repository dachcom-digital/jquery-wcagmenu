/*


 jquery-wcagmenu widget
 Copyright 2015 DACHCOM.DIGITAL AG

 @author Volker Andres
 @see https://github.com/dachcom-digital/jquery-wcagmenu
 @license MIT
 @version 0.1.5
*/
(function(d){d.widget("dcd.wcagmenu",{options:{classOpen:"open",classFocus:"focus",controls:{},openDelay:300,closeDelay:300,childMenuSelector:"div:first",useMenuAim:!0},_keys:{tab:9,enter:13,esc:27,space:32,left:37,up:38,right:39,down:40},_currentFocus:d(),_closeTimeout:void 0,_openTimeout:void 0,_openDelay:300,_closeDelay:300,_mousePoints:{},_create:function(){this._on({keydown:"_keyevent",focus:"_focus",blur:"_blur",mouseover:"_mouseover",mousemove:"_mousemove",mouseleave:"_mouseleave",mouseenter:"_mouseenter"});
this._openDelay=this.options.openDelay;this._closeDelay=this.options.closeDelay;this._isTouchDevice()&&(this._openDelay=0);this.element.find("a").attr("tabindex",-1)},_isTouchDevice:function(){return void 0!==window.ontouchstart||window.navigator.MaxTouchPoints||window.navigator.msMaxTouchPoints||window.navigator.userAgent.toLowerCase().match(/windows phone os 7/i)},_mouseenter:function(){void 0!==this._closeTimeout&&window.clearTimeout(this._closeTimeout)},_mouseleave:function(){var a=this;void 0!==
a._closeTimeout&&window.clearTimeout(a._closeTimeout);a._closeTimeout=window.setTimeout(function(){a.element.find("."+a.options.classFocus).removeClass(a.options.classFocus);a._closeMenu()},a._closeDelay)},_mouseover:function(a){a=d(a.target).closest("[class*=level-]");a.length&&(this._currentFocus.length||this._isTouchDevice()||this.element.trigger("focus",{initial:!0}),this._getLevel(a)>this._getCurrentLevel()&&(window.clearTimeout(this._openTimeout),this._activateItem(a)))},_mousemove:function(a){d(a.target).closest("[class*=level-]").length&&
this._openItem(a)},_openItem:function(a){var b=this,c=b._currentFocus,e=c.find(this.options.childMenuSelector),l=d(a.target).closest("[class*=level-]"),f=this._openDelay;c.length?window.clearTimeout(this._openTimeout):f=0;0<f&&!b._currentFocus.find("[class*=level-]").length&&(f=0);0<f&&c.length&&e.length&&(this._resetDelayForMouse(a,l,e,c)&&(f=0),b._mousePoints.x=a.pageX,b._mousePoints.y=a.pageY);0===f?this._activateItem(l):this._openTimeout=window.setTimeout(function(){b._activateItem(l);b._mousePoints=
{}},f)},_activateItem:function(a){this._closeItems(a);this._currentFocus=this._addFocus(a);this._currentFocus.find("[class*=level-]").length&&this._currentFocus.addClass(this.options.classOpen);this._currentFocus.closest("[class*=level-]")&&this._currentFocus.parents("[class*=level-]").addClass(this.options.classFocus+" "+this.options.classOpen);this._trigger("open",{},[this._currentFocus])},_closeItems:function(a){var b,c=this,e=d(a).parents().has(this._currentFocus).first().closest("[class*=level-]");
b=this._currentFocus.parentsUntil(e,"[class*=level-]").andSelf();a=a.parentsUntil(e,"[class*=level-]").andSelf();b.not(a).each(function(){var a=d(this);c._removeFocus(a);a.hasClass(c.options.classOpen)&&(a.removeClass(c.options.classOpen),c._trigger("close",{},[a]))})},_addFocus:function(a){a.addClass(this.options.classFocus);this._trigger("focus",{},[a]);return a},_removeFocus:function(a){return a.removeClass(this.options.classFocus)},_resetDelayForMouse:function(a,b,c,e){if(!this.options.useMenuAim)return!1;
var l=this._getCurrentLevel(),f,d,m,k,g,h,n;if(void 0===this.options.controls[l])return!1;"open"===this.options.controls[l].down&&(f="down");"open"===this.options.controls[l].right&&(f="right");"open"===this.options.controls[l].left&&(f="left");"open"===this.options.controls[l].up&&(f="up");"open"===b.data("down")&&(f="down");"open"===b.data("right")&&(f="right");"open"===b.data("left")&&(f="left");"open"===b.data("up")&&(f="up");switch(f){case "down":d=e.offset().left+e.width()/2;m=e.offset().top+
e.height();k=c.offset().left;g=c.offset().top;h=c.offset().left+c.width();n=c.offset().top;break;case "right":d=e.offset().left+e.width();m=e.offset().top+e.height()/2;k=c.offset().left;g=c.offset().top;h=c.offset().left;n=c.offset().top+c.height();break;case "left":d=e.offset().left;m=e.offset().top+e.height()/2;k=c.offset().left+c.width();g=c.offset().top;h=c.offset().left+c.width();n=c.offset().top+c.height();break;case "up":d=e.offset().left+e.width()/2,m=e.offset().top,k=c.offset().left,g=c.offset().top+
c.height(),h=c.offset().left+c.width(),n=c.offset().top+c.height()}b=this._checkLineIntersection(this._mousePoints.x,this._mousePoints.y,a.pageX,a.pageY,d,m,k,g);d=this._checkLineIntersection(this._mousePoints.x,this._mousePoints.y,a.pageX,a.pageY,d,m,h,n);a=this._checkLineIntersection(this._mousePoints.x,this._mousePoints.y,a.pageX,a.pageY,k,g,h,n);return!1===b.onLine2&&!1===d.onLine2&&!1===a.onLine2?!0:!1},_checkLineIntersection:function(a,b,c,e,d,f,q,m){var k,g,h,n,p={x:null,y:null,onLine1:!1,
onLine2:!1};k=(m-f)*(c-a)-(q-d)*(e-b);if(0===k)return p;g=b-f;h=a-d;n=(c-a)*g-(e-b)*h;g=((q-d)*g-(m-f)*h)/k;h=n/k;p.x=a+g*(c-a);p.y=b+g*(e-b);0<g&&1>g&&(p.onLine1=!0);0<h&&1>h&&(p.onLine2=!0);return p},_focus:function(a,b){b=b||{};var c=d(a.target);!b.initial&&c.is(this.element)&&this._focusMenu()},_blur:function(a){d(a.target).is(this.element)&&this._closeMenu()},_keyevent:function(a){switch(a.keyCode){case this._keys.tab:return this._closeMenu();case this._keys.esc:return this._closeMenu(),this._focusMenu();
case this._keys.down:return this._key("down");case this._keys.up:return this._key("up");case this._keys.left:return this._key("left");case this._keys.right:return this._key("right");case this._keys.space:return this._open("space");case this._keys.enter:return this._action()}},_getLevel:function(a){a=(a.attr("class")||"").match(/level-(\d+)/i);return null===a?0:window.parseInt(a[1],10)},_getCurrentLevel:function(){return this._getLevel(this._currentFocus)},_getSiblings:function(){var a=this._getCurrentLevel();
return 1===a?this.element.find(".level-"+a):this._currentFocus.closest(".level-"+(a-1)).find(".level-"+a)},_open:function(a){var b;b=this._getCurrentLevel();var c=this._currentFocus;b=this._currentFocus.find(".level-"+(b+1)+":first");return b.length?(this._currentFocus.addClass(this.options.classOpen),this._currentFocus=this._addFocus(b),this._trigger("open",{},[c]),!1):"space"===a?this._action():!1},_close:function(){var a;a=this._getCurrentLevel();a=this._currentFocus.closest(".level-"+(a-1));a.length&&
(this._currentFocus=a.removeClass(this.options.classOpen),a.find("."+this.options.classFocus+", ."+this.options.classOpen).removeClass(this.options.classFocus+" "+this.options.classOpen),this._trigger("close",{},[a]));return!1},_action:function(){window.location.href=this._currentFocus.find("a").attr("href");return!1},_key:function(a){var b=this._getCurrentLevel();a=this._currentFocus.data(a)||this.options.controls[b][a];return this["_"+(a||"none")]()},_none:function(){return!1},_left:function(){var a,
b;a=this._getSiblings();b=a.index(this._currentFocus);0!==b&&(this._removeFocus(this._currentFocus),this._currentFocus=this._addFocus(a.eq(b-1)));return!1},_leftLoop:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);this._currentFocus=0===b?this._addFocus(a.eq(a.length-1)):this._addFocus(a.eq(b-1));return!1},_leftClose:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);0===b?this._close():
this._currentFocus=this._addFocus(a.eq(b-1));return!1},_right:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);b!==a.length-1&&(this._removeFocus(this._currentFocus),this._currentFocus=this._addFocus(a.eq(b+1)));return!1},_rightLoop:function(){var a,b;a=this._getSiblings();b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);this._currentFocus=b===a.length-1?this._addFocus(a.eq(0)):this._addFocus(a.eq(b+1));return!1},_rightClose:function(){var a,b;a=this._getSiblings();
b=a.index(this._currentFocus);this._removeFocus(this._currentFocus);b===a.length-1?this._close():this._currentFocus=this._addFocus(a.eq(b+1));return!1},_up:function(){return this._left()},_upLoop:function(){return this._leftLoop()},_upClose:function(){return this._leftClose()},_down:function(){return this._right()},_downLoop:function(){return this._rightLoop()},_downClose:function(){return this._rightClose()},_focusMenu:function(){this._removeFocus(this.element.find("."+this.options.classFocus));
this._currentFocus=this._currentFocus.length?this._addFocus(this._currentFocus.closest(".level-1")):this._addFocus(this.element.find(".level-1:first"))},_closeMenu:function(){var a=this,b;d.each(this.element.find("."+this.options.classOpen),function(){b=d(this);b.removeClass(a.options.classOpen);a._trigger("close",{},[b])});this._removeFocus(this.element.find("."+this.options.classFocus));this._trigger("closemenu",{},[this.element])},_destroy:function(){this._closeMenu();this.element.find("[tabindex]").removeAttr("tabindex")}})})(jQuery);
